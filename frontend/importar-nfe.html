<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importar NFe - Sistema Financeiro Finco</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/auth.js"></script>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <img src="assets/logo-finco.png" alt="Finco" class="header-logo">
        <h1 class="header-titulo">Sistema Financeiro</h1>
        <div class="header-busca">
            <input type="text" id="busca-global" class="busca-input" placeholder="Buscar lan√ßamentos..." onkeypress="if(event.key==='Enter') buscarGlobal()">
            <button class="btn btn-sm btn-primary" onclick="buscarGlobal()">Buscar</button>
        </div>
        <div class="header-user">
            <span id="usuario-logado">Admin</span>
            <button class="btn btn-sm btn-secondary" onclick="fazerLogout()" title="Sair">Sair</button>
        </div>
    </header>

    <!-- NAVEGA√á√ÉO -->
    <nav class="nav-menu">
        <ul>
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="lancamentos.html">Lan√ßamentos</a></li>
            <li><a href="contas.html">Contas</a></li>
            <li><a href="fluxo-caixa.html">Fluxo de Caixa</a></li>
            <li><a href="relatorios.html">Relat√≥rios</a></li>
            <li><a href="importar-nfe.html" class="active">Importar NFe</a></li>
            <li><a href="configuracoes.html">Configura√ß√µes</a></li>
        </ul>
    </nav>

    <!-- CONTAINER PRINCIPAL -->
    <main class="container">
        <div id="alerta-container"></div>

        <!-- T√çTULO -->
        <div class="d-flex justify-between align-center mb-2">
            <h2>Importar NFe</h2>
        </div>
        <p class="text-muted mb-3">Importe notas fiscais da SEFAZ ou via upload de XML</p>

        <!-- STATUS DO CERTIFICADO -->
        <section class="card mb-3">
            <div class="card-header">
                Status da Integra√ß√£o SEFAZ
            </div>
            <div class="card-body">
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">Certificado:</span>
                        <span class="status-valor" id="status-certificado">Verificando...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Senha:</span>
                        <span class="status-valor" id="status-senha">Verificando...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Ambiente:</span>
                        <span class="status-valor" id="status-ambiente">-</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- ABAS -->
        <div class="tabs-container mb-3">
            <button class="tab-btn active" onclick="trocarAba('sefaz')">Consultar SEFAZ</button>
            <button class="tab-btn" onclick="trocarAba('upload')">Upload de XML</button>
        </div>

        <!-- ABA SEFAZ -->
        <section id="aba-sefaz" class="tab-content">
            <div class="card mb-3">
                <div class="card-header">
                    Consultar NFe na SEFAZ
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">
                        Busca todas as NFe destinadas ao CNPJ da Finco que ainda n√£o foram baixadas.
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">√öltimo NSU (para continuar busca)</label>
                            <input type="text" id="ultimo-nsu" class="form-control" value="0" placeholder="0">
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="consultarSefaz()" id="btn-consultar">
                                üîç Consultar SEFAZ
                            </button>
                        </div>
                    </div>
                    <div id="sefaz-resultado" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <strong>√öltimo NSU:</strong> <span id="resultado-ult-nsu">-</span> | 
                            <strong>M√°ximo NSU:</strong> <span id="resultado-max-nsu">-</span> |
                            <strong>Documentos:</strong> <span id="resultado-total">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ABA UPLOAD -->
        <section id="aba-upload" class="tab-content" style="display: none;">
            <div class="card mb-3">
                <div class="card-header">
                    Upload de Arquivos XML
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">
                        Selecione um ou mais arquivos XML de NFe para importar.
                    </p>
                    <div class="upload-area" id="upload-area">
                        <input type="file" id="input-xml" multiple accept=".xml" style="display: none;" onchange="processarUpload()">
                        <div class="upload-content" onclick="document.getElementById('input-xml').click()">
                            <span class="upload-icon">üìÅ</span>
                            <p>Clique para selecionar ou arraste os arquivos XML</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- DOCUMENTOS ENCONTRADOS -->
        <section class="card mb-3" id="secao-documentos" style="display: none;">
            <div class="card-header d-flex justify-between align-center">
                <span>Documentos Encontrados</span>
                <span id="contador-docs" class="text-muted">0 documentos</span>
            </div>
            <div class="card-body">
                <!-- Op√ß√µes de importa√ß√£o -->
                <div class="form-row mb-3">
                    <div class="form-group">
                        <label class="form-label">Categoria Padr√£o</label>
                        <select id="categoria-importar" class="form-control">
                            <option value="OPERACIONAL" selected>Operacional</option>
                            <option value="FINANCEIRO">Financeiro</option>
                            <option value="INVESTIMENTO">Investimento</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Classifica√ß√£o Padr√£o</label>
                        <select id="classificacao-importar" class="form-control">
                            <option value="">Autom√°tica</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-success" onclick="importarSelecionados()">
                            ‚úÖ Importar Selecionados
                        </button>
                    </div>
                </div>
                
                <!-- Tabela de documentos -->
                <div class="tabela-container">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="check-todos" onchange="toggleTodos()"></th>
                                <th>Tipo</th>
                                <th>N¬∫ NF</th>
                                <th>Emitente/Destinat√°rio</th>
                                <th>Data Emiss√£o</th>
                                <th>Vencimento</th>
                                <th class="text-right">Valor</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-documentos">
                            <tr>
                                <td colspan="8" class="text-center text-muted">Nenhum documento</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- LOG DE IMPORTA√á√ÉO -->
        <section class="card" id="secao-log" style="display: none;">
            <div class="card-header">
                Log de Importa√ß√£o
            </div>
            <div class="card-body">
                <div id="log-importacao" class="log-container"></div>
            </div>
        </section>
    </main>

    <script src="js/api.js"></script>
    <script src="js/importar-nfe.js"></script>
</body>
</html>
